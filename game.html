<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <style>
        #barcode_for_game {
            visibility: hidden
        }
    </style>
    <script src="JsBarcode.all.min.js"></script>
    <script type="text/javascript">

    // https://stackoverflow.com/questions/5448545/how-to-retrieve-get-parameters-from-javascript/
    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        location.search
            .substr(1)
            .split("&")
            .forEach(function (item) {
            tmp = item.split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            });
        return result;
    }

    function place_barcode_random(barcode, barcode_content){
        JsBarcode("#barcode_for_game", barcode_content, {width: 1.5, height: 20});

        var new_angle = Math.random() * 360;
        barcode.style.transformOrigin = "50% 50%";
        barcode.style.transform = "rotate(" + new_angle + "deg)";

        var min_x = 0;
        var min_y = 0;
        var max_x = window.innerWidth; // - barcode_width;
        var max_y = window.innerHeight; // - barcode_height;
        var new_barcode_x = min_x + Math.random() * (max_x - min_x); 
        var new_barcode_y = min_y + Math.random() * (max_y - min_y);

        barcode.style.position = "absolute";
        barcode.style.left = new_barcode_x + 'px';
        barcode.style.top = new_barcode_y + 'px';

        barcode_box = barcode.getBoundingClientRect()
        console.log("barcode is now at " + barcode.style.left + ", " +  barcode.style.top)
        console.log(barcode_box)

        if (barcode_box['top'] < min_y || barcode_box['bottom'] > max_y || barcode_box['left'] < min_x || barcode_box['right'] > max_x){
            console.log("Positioned barcode out of canvas. Retrying.")
            place_barcode_random(barcode);
        }
    }

    function score_and_redirect(start_time, redirect_url){
        var end_time = new Date();
        var time_diff = end_time - start_time;
        console.log("Elapsed time was: " + time_diff + " ms")
        console.log("Redirecting to: " + redirect_url + "?time=" + time_diff)
        window.location.replace(redirect_url + '?ms=' + time_diff)
    }

    function is_accepted_char(key) {
        return key.length == 1;
        //return ((key >= 'a' && key <= 'z') || (key >= 'A' && key <= 'Z'))
    }

    function BarcodeReader(callback) {
        this.char_buffer = "";
        this.callback = callback;

        this.incomming_keystroke = function(event){
            console.log("Input key: '" + event.key + "' Is accepted char: " + is_accepted_char(event.key))
            if (event.key == "Enter") {
                console.log("Calling BarcodeReader callback with string: " + this.char_buffer);
                this.callback(this.char_buffer);
                this.char_buffer = "";
            } else if (is_accepted_char(event.key)) {
                this.char_buffer += event.key;
            }
        }

    }

    // https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
    function random_string(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    function barcode_game() {
        var next_round_barcode_string = random_string(7)      
        /*scoreboard_url*/
        var redirect_url = findGetParameter("redirect") || "index.html"

        /* get rounds */
        var rounds = parseInt(findGetParameter("rounds")) || 10;
        console.log("Will play " + rounds + " rounds")

        /* play game for number of rounds */
        var barcode = document.getElementById("barcode_for_game");
        place_barcode_random(barcode, next_round_barcode_string);
        barcode.style.visibility = "visible";
        var start_time = new Date();

        var barcode_reader = new BarcodeReader(function(barcode_string){
            if (barcode_string == next_round_barcode_string) {
                if (rounds > 1){
                    rounds = rounds - 1;
                    console.log(rounds + " rounds left!");
                    next_round_barcode_string = random_string(7)
                    place_barcode_random(barcode, next_round_barcode_string);
                } else {
                    console.log("Game done");
                    score_and_redirect(start_time, redirect_url);
                    }
            }
        })

        document.addEventListener('keydown', function(event){barcode_reader.incomming_keystroke(event)});

    }
    </script>
</head>

<body onload="barcode_game()">
    <svg id="barcode_for_game"></svg>
</body>
</html>
